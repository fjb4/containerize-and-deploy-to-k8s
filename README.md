# Containerize .NET and Deploy to Kubernetes

## Tested with

- [.NET SDK 5.0.103](https://dotnet.microsoft.com/download/visual-studio-sdks)
- [Docker Desktop 3.5.2](https://www.docker.com/products/docker-desktop)
- [Pack CLI 0.20.0](https://buildpacks.io/docs/tools/pack/)

## Demo Script

- Build app, run it locally
  - `dotnet new mvc -o dotnet-demo`
  - `dotnet run`
  - Update app to show current time and environment variables, rerun it
- Containerize the app, run in Docker
  - Why containers?
    - Provide a way to package up your application with its runtime environment and all dependencies
      - Consistency across environments
    - Similar to virtual machines but more lightweight, use fewer resources
      - Containers share the host machine's operating system kernel
    - Linux or Windows containers are available
    - Container format is controlled by [Open Container Initiative](https://opencontainers.org/)
      - Containers can be used in Docker or Kubernetes
  - [Dockerfile](https://docs.docker.com/engine/reference/builder/)
    - Dockerfile is a text file that contains all the commands to build a container image
      - TODO: Explain container vs image
    - The `docker image build` command runs the commands in the Dockerfile and outputs an image
      - Dockerfiles can be complex
    - [Example of a Dockerfile](https://github.com/docker-library/python/blob/7217b72192c93ca2033051d7191d5689932d3912/3.6/alpine3.12/Dockerfile)
    - Commands
      - `docker image build -t dotnet-demo-dockerfile .`
      - `docker container run -p 80:80 dotnet-demo-dockerfile`
  - [Buildpacks](https://buildpacks.io/)
    - Buildpacks provide an alternative way to build container images
    - .NET
      - `rm Dockerfile`
      - `rm obj`
      - `rm bin`
      - `pack build dotnet-demo-buildpacks`
      - `docker container run -p 80:80 dotnet-demo-buildpacks`
    - Java
      - `pack build java-demo-buildpacks`
  - Push app to an [image registry](https://hub.docker.com/)
    - `docker image tag dotnet-demo-buildpacks fjb4/dotnet-demo-buildpacks`
    - `docker image push fjb4/dotnet-demo-buildpacks`
    - [View image on Docker Hub](https://hub.docker.com/repository/docker/fjb4/dotnet-demo-buildpacks)
- Run in [Kubernetes](https://kubernetes.io/)
  - Local Kubernetes
    - [Enable Kubernetes in Docker Desktop](https://docs.docker.com/desktop/kubernetes/)
    - Intro to [kubectl](https://kubernetes.io/docs/tasks/tools/)
      - `kubectl config get-contexts`
      - `kubectl get pod`
    - Deploy to Kubernetes
      - `kubectl create deployment dotnet-demo --image=fjb4/dotnet-demo-buildpacks --port=8080 --replicas=1 --dry-run -o yaml > deploy.yaml`
        - Edit deploy.yaml to inject environment variables and image pull policy
      - `kubectl expose deployment/dotnet-demo --type=LoadBalancer --port=80 --target-port=8080 --dry-run -o yaml > service.yaml`
      - View application in browser
      - Show application log updates as page is refreshed
        - `kubectl logs <pod-name>`
  - Cloud Kubernetes
    - Options
      - [Google Kubernetes Engine (GKE)](https://cloud.google.com/kubernetes-engine)
      - [Azure Kubernetes Service (AKS)](https://azure.microsoft.com/en-us/services/kubernetes-service)
      - [Amazon Elastic Kubernetes Service (EKS)](https://aws.amazon.com/eks)
    - Deploy to GKE
      - [Create GKE cluster](https://console.cloud.google.com)
      - Connect to GKE cluster
      - `kubectl apply -f deploy.yaml`
      - `kubectl apply -f service.yaml`
      - `kubectl scale deployment/dotnet-demo --replicas=5`
        - Show pod name and IP change when page refreshed
        - Show what happens when you delete a pod
          - `kubectl delete pod <pod-name>`
      - View logs
        - `kubectl logs <pod-name>`
    - Deploy SQL Server to Kubernetes
      - Update app to query SQL Server, rerun it
        - `dotnet add package Microsoft.Data.SqlClient --version 3.0.0`
      - `kubectl apply -f sql-deploy.yaml`
      - Show SQL Server running in Kubernetes
        - `kubectl get pod`
      - Refresh app, show that it is connecting to SQL Server
  